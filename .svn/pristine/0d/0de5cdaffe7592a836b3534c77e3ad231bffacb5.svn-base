import React, {useState} from "react";
import PropTypes from 'prop-types'
import { MainContainer, InnerContainer, Column, StyledInput, Row, StyledTitle, StyledClearIcon,
    StyledSubTitle, StyledRadio, Card, CardTitle, Footer, MainColumn, MaxHeightDiv, FooterColumn, PriceTitle,
    StyledButton, ButtonText } from './comboPage.styled'
import RadioGroup from '@mui/material/RadioGroup';
import Grid from '@mui/material/Grid';
import FormControl from '@mui/material/FormControl';
import { useTheme } from '@mui/material/styles'
import { getHttpResponse } from "../../api/helper";

const ComboPage = ({selectedComboItem, clearComboPage,  addComboToCartHandler, catalogId, companyBranchId, setAlert})=> {
    const [combo, setCombo] = useState()
    const theme = useTheme();
    const [selectedProductIndexes, setSelectedProductIndexes] = useState()
    const [comboQuantity, setComboQuantity] = useState(1)
    const isPriceVariable = isNaN(selectedComboItem.price)
    const [accPrice, setAccPrice] = useState(0)

    const getCombo = async () => {
        try{
            const response = await getHttpResponse(`item-service/combo/${selectedComboItem.id}?catalogId=${catalogId}&companybranchid=${companyBranchId}`)
            setCombo(response.data)
            setSelectedProductIndexes(response.data?.sections.map(() => -1))
        }
        catch(error){
            clearComboPage()
            setAlert({open: true, severity: 'error', message: error?.message || 'OcurriÃ³ un error buscando los datos', duration: 3000})
        }
    }

    useState(() => {
        getCombo()
    }, [])
 

    const radioChangeHandler = (value, sectionIndex) => {
        const newState = [...selectedProductIndexes];
        newState[sectionIndex] = value
        isPriceVariable && setAccPrice(newState.reduce((acc, current, index) => {
            if (current === -1) return acc + 0
            const price = combo.sections[index].products[current].price            
            return acc + (price ? price * 1 : 0 )
        },0))
        setSelectedProductIndexes(newState)
    }

    return <MainContainer>
        <InnerContainer>
            {combo && <MainColumn>
                <MaxHeightDiv>
                    <Column>
                        <Row>
                            <Row>
                                <StyledInput sx={{ input: { color: '#696969' } }} value={comboQuantity} disableUnderline type='number' onChange={(e) => e.target.value > 0 && setComboQuantity(e.target.value) }/>
                                <StyledTitle>
                                    {selectedComboItem.name}
                                </StyledTitle>
                            </Row>
                        <div>
                            <StyledClearIcon onClick={clearComboPage} />
                        </div>
                        </Row>
                        {
                            combo.sections?.map((section, sectionIndex) => {
                                return <div key={section.sectionId}>
                                        <StyledSubTitle> {section.name} </StyledSubTitle>
                                        <FormControl style={{width: '100%'}}>
                                        <RadioGroup
                                            value={selectedProductIndexes[sectionIndex]}
                                            onChange={() => {}}
                                        >
                                            <Grid container spacing={2}>
                                            {section.products.map((product, productIndex) => <Grid item key={product.id} xs={12} md={3}>
                                                <Card onClick={() => radioChangeHandler(productIndex, sectionIndex)} selected = {selectedProductIndexes[sectionIndex] === productIndex} selectedColor = {theme.palette.secondary.main}>
                                                    <CardTitle selected = {selectedProductIndexes[sectionIndex] === productIndex}>{`${product.name}${product.price*1 > 0 ? ` (${(product.price*1).toFixed(2)})` : '' }`}</CardTitle>
                                                    <StyledRadio sx={{
                                                        '&.Mui-checked': {
                                                            color: 'white',
                                                        },
                                                        }} 
                                                        value={productIndex} />
                                                </Card>
                                            </Grid>
                                            )}
                                            </Grid>
                                        </RadioGroup>
                                        </FormControl>
                                    </div>
                            })
                        }
                    </Column>
                </MaxHeightDiv>
                <Footer>
                    <FooterColumn>
                        <PriceTitle>{`RD$ ${isPriceVariable ? accPrice === 0 ? selectedComboItem.price : accPrice.toFixed(2) : (selectedComboItem.price * comboQuantity).toFixed(2)}`}</PriceTitle>
                        <StyledButton  onClick={() => addComboToCartHandler({...selectedComboItem, selectedProductIndexes,
                                quantity: comboQuantity, price: isPriceVariable ? accPrice.toFixed(2).toString() : selectedComboItem.price })} disabled={selectedProductIndexes.some(index => index === -1)} sx={{
                            "&.Mui-disabled": {
                                pointerEvents: "unset", 
                                cursor: "not-allowed"
                            }
                        }}>
                            <ButtonText>Agregar al Carrito</ButtonText>
                        </StyledButton>
                    </FooterColumn>
                </Footer>
            </MainColumn> }
        </InnerContainer>
    </MainContainer>
}

ComboPage.propTypes = {
    selectedComboItem: PropTypes.object.isRequired,
    clearComboPage: PropTypes.func,
    addComboToCartHandler: PropTypes.func,
    setAlert: PropTypes.func,
    catalogId: PropTypes.number.isRequired,
    companyBranchId: PropTypes.number.isRequired,
}

export default ComboPage